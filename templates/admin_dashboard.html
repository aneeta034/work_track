<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Admin Dashboard{% endblock %}</title>

  <!--password-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">


  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Lightbox CSS -->
<link href="https://cdn.jsdelivr.net/npm/lightbox2@2.11.3/dist/css/lightbox.min.css" rel="stylesheet">
  <!-- FontAwesome Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- External CSS -->
  <link rel="stylesheet" href="{% static 'assets/css/admin_dashboard.css' %}">
  <style>
    .link-style {
        color: grey; /* Initial color */
        text-decoration: none; /* Remove underline */
        transition: color 0.3s ease; /* Smooth transition for hover effect */
    }
  
    .link-style:hover {
        color: black; /* Hover color */
        text-decoration: none; /* Ensure no underline on hover */
    }
    .card:hover {
    transform: none !important;
    transition: none !important;
}
  </style>


</head>
<body>
  
  <!-- Topbar -->
  <div class="topbar">
    <div class="d-flex align-items-center">
      <!-- Logo -->
      <a href="{% url 'admin_dashboard' %}" class="logo">
        <img src="{% static 'assets/img/velvetek.jpg' %}" alt="navbar brand" />
      </a>
      <!-- Hamburger Menu -->
      <span class="hamburger" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
      </span>
    </div>
    <!-- Admin text on the right side -->
    <span class="admin-text">Hi,{{user.username}}</span>
  </div>

  <div class="sidebar">
    <a href="{% url 'admin_dashboard' %}"><i class="fas fa-home"></i><span>Home</span></a>
    <a href="#" onclick="openCustomerModal()"><i class="fas fa-user-plus"></i><span>Add Customer</span></a>
    <a href="#" onclick="openTechnicianModal()"><i class="fas fa-user-cog"></i><span>Add Technician</span></a>
    <a href="#" onclick="openModal()"><i class="fas fa-tools"></i><span>Add Service</span></a>
    <a href="{% url 'logout' %}"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
</div>


  <!-- Main Content -->
<div class="main-content">
    <!-- Flash Message Container -->
<div id="flashMessageContainer" class="position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 1050;"></div>


    <!-- Cards Section -->
    <div class="row">
      <div class="col-md-4">
        <!-- Customers Card -->
        <a href="{% url 'new_customer' %}" class="text-decoration-none">
          <div class="card p-3 mb-3">
            <div class="d-flex align-items-center">
              <i class="fas fa-users card-icon me-3"></i>
              <div>
                <h3 class="mb-1" style="color:grey;">Customers</h3>
              </div>
              <h1 class="ms-auto mb-0">{{ customer_count }}</h1>
            </div>
          </div>
        </a>
      </div>
      <div class="col-md-4">
        <a href="{% url 'list_technicians' %}" class="text-decoration-none">
          <div class="card p-3 mb-3">
            <div class="d-flex align-items-center">
              <i class="fas fa-user-cog card-icon me-3"></i>
              <div>
                <h3 class="mb-1" style="color:grey">Technicians</h3>
              </div>
              <h1 class="ms-auto mb-0">{{ technician_count  }}</h1>
            </div>
          </div>
        </a>
      </div>
      <div class="col-md-4">
        <a href="{% url 'admin_dashboard' %}" class="text-decoration-none">
          <div class="card p-3 mb-3">
            <div class="d-flex align-items-center">
              <i class="fas fa-tools card-icon me-3"></i>
              <div>
                <h3 class="mb-1" style="color:grey">Services</h3>
              </div>
              <h1 class="ms-auto mb-0">{{ total_services   }}</h1>
            </div>
          </div>
        </a>
    </div>
    </div>
    
  

    {% block content %}

    <!-- Tasks Section -->
    <h3 class="mt-0 mb-2">Tasks</h3>
    <div class="navbar">
      <div class="nav-left">
        <a href="{% url 'switch_task' %}?filterType={{ request.GET.filterType }}&query={{ request.GET.query }}&start={{ request.GET.start }}&end={{ request.GET.end }}" 
           class="filter-option {% if current_filter != 'Assigned' and current_filter != 'Pending' and current_filter != 'Completed' %}selected{% endif %}">
            All Tasks
        </a>
    
        <a href="{% url 'switch_task_filter' status='Assigned' %}?filterType={{ request.GET.filterType }}&query={{ request.GET.query }}&start={{ request.GET.start }}&end={{ request.GET.end }}" 
           class="filter-option {% if current_filter == 'Assigned' %}selected{% endif %}">
            Assigned
        </a>
    
        <a href="{% url 'switch_task_filter' status='Pending' %}?filterType={{ request.GET.filterType }}&query={{ request.GET.query }}&start={{ request.GET.start }}&end={{ request.GET.end }}" 
           class="filter-option {% if current_filter == 'Pending' %}selected{% endif %}">
            Pending
        </a>
    
        <a href="{% url 'switch_task_filter' status='Completed' %}?filterType={{ request.GET.filterType }}&query={{ request.GET.query }}&start={{ request.GET.start }}&end={{ request.GET.end }}" 
           class="filter-option {% if current_filter == 'Completed' %}selected{% endif %}">
            Completed
        </a>
    </div>
    
      <form id="filterForm">
        <div class="nav-right d-flex align-items-center">
            <!-- Filter Icon -->
            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-filter"></i> <!-- Font Awesome filter icon -->
                </button>
                <ul class="dropdown-menu" aria-labelledby="filterDropdown">
                    <li><a class="dropdown-item" href="#" data-filter="date">By Date</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="month">By Month</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="year">By Year</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="dateRange">By Date Range</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="monthRange">By Month Range</a></li>
                    <li><a class="dropdown-item" href="#" data-filter="yearRange">By Year Range</a></li>
                </ul>
            </div>
    
            <!-- Search Bar -->
            <input type="text" id="searchBar" name="query" class="form-control custom-search ms-2" placeholder="Search by Date">
    
            <!-- Range Fields -->
            <div id="rangeFields" class="d-none d-flex ms-2">
                <input type="text" id="startValue" name="start" class="form-control me-2" placeholder="Start">
                <input type="text" id="endValue" name="end" class="form-control" placeholder="End">
            </div>
    
            <!-- Buttons -->
            <button type="button" class="btn btn-primary btn-sm ms-2" id="searchBtn">Search</button>
            <button type="button" class="btn btn-secondary btn-sm ms-2" id="resetBtn">Reset</button>
            <button type="button" class="btn btn-secondary btn-sm ms-2" onclick="exportData()">Export</button>
        </div>
    </form>
      
    </div>
    
   <!-- Add Service Modal -->
<div id="addServiceModal" class="modal">
  <div class="modal-content">
    <!-- Top Bar -->
    <div class="modal-topbar">
      <h2>Add Service</h2>
      <span class="close" onclick="closeModal()">&times;</span>
    </div>

    <form id="addServiceForm" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="modal-grid">
        <!-- Column 1 -->
        <div class="modal-column">
          <div class="form-group">
            <label for="contact_number">Customer Number <span class="required">*</span></label>
            <input type="text" id="contact_number" name="contact_number" oninput="searchCustomer()">
            <div id="customer_results"></div>
            <div id="customer_not_found" class="text-danger" style="display: none;">Customer not found. Please enter details manually.</div>
            <small id="customer_error" class="text-danger"></small>
          </div>
          <div class="form-group">
            <label for="name">Name <span class="required">*</span></label>
            <input type="text" id="name" name="name" readonly>
          </div>
          <div class="form-group">
            <label for="address">Address <span class="required">*</span></label>
            <input type="text" id="address" name="address" readonly>
          </div>
          <div class="form-group">
            <label for="whatsapp_number">WhatsApp Number <span class="required">*</span></label>
            <input type="text" id="whatsapp_number" name="whatsapp_number" readonly>
          </div>
          <div class="form-group checkbox-group">
            <input type="checkbox" id="same_as_contact" onchange="copyContactToWhatsApp()">
            <label for="same_as_contact">Same as Contact Number</label>
          </div>
          <div class="form-group">
            <label for="referred_by">Referred By <span class="required">*</span></label>
            <input type="text" id="referred_by" name="referred_by" readonly>
          </div>
        </div>

        <!-- Column 2 -->
        <div class="modal-column">
          <div class="form-group">
            <label for="service_by">Service By <span class="required">*</span></label>
            <select id="service_by" name="service_by">
              <option value="">Select a technician</option>
            </select>
          </div>
          <div class="form-group">
            <label for="work_type">Work Type <span class="required">*</span></label>
            <select id="work_type" name="work_type">
              <option value="sale">Sale</option>
              <option value="service">Service</option>
            </select>
          </div>
          <div class="form-group">
            <label for="item_name_or_number">Item Name/Number <span class="required">*</span></label>
            <input type="text" id="item_name_or_number" name="item_name_or_number">
          </div>
          <div class="form-group">
            <label for="issue">Issue Description</label>
            <textarea id="issue" name="issue" rows="7"></textarea>
          </div>
        </div>

        <!-- Column 3 -->
        <div class="modal-column">
          <div class="form-group">
            <label for="photos_of_item">Upload Photo</label>
            <div class="file-input-container">
                <input type="file" id="photos_of_item" name="photos_of_item" multiple>
                <div id="fileNamesDisplay" class="file-names-display">No files chosen</div>
            </div>
        </div>
        <div class="form-group">
          <label for="estimation_document">Upload Document</label>
          <input type="file" id="estimation_document" name="estimation_document">
          <div id="estimation_document_display" class="doc-display"></div>  <!--  Added this for display -->
      </div>
          <div class="form-group">
            <label for="estimated_price">Estimated Price</label>
            <input type="text" id="estimated_price" name="estimated_price">
          </div>
          <div class="form-group">
            <label for="estimated_date">Estimated Date <span class="required">*</span></label>
            <input type="date" id="estimated_date" name="estimated_date">
          </div>
          <div class="form-group">
            <label for="any_other_comments">Comments</label>
            <textarea id="any_other_comments" name="any_other_comments"></textarea>
          </div>
        </div>
      </div>
      <div class="form-submit">
        <button type="submit" class="btn btn-primary">Submit</button>
      </div>
    </form>
    <div id="serviceMessage"></div>
  </div>
</div>
 

  <!-- Table Section -->
  <div class="table-responsive mt-2">
    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>ID</th>
          <th>Customer Name</th>
          <th>Additional Charges</th>
          <th>status</th> 
          <th>Address</th>
          <th>Contact Details</th> 
          <th>Referred By</th>
          <th>Work Type</th>
          <th>Item Name/Number</th>
          <th>Issue</th>
          <th>Estimated Price</th>
          <th>Estimated Date</th>
          <th>Service By</th>
          <th>Files</th>
          <th>Comments</th>
        </tr>
      </thead>
      <tbody>
        {% for service in applied_services %}
        <tr>
          <td>
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
              <span>{{ service.id }}</span> <!-- Display ID on the first line, centered -->
              <div style="display: flex; margin-top: 5px;">
                <button class="edit-service-btn" data-service-id="{{ service.id }}" data-toggle="modal" data-target="#serviceModal" 
                          style="border: none; background: none; padding: 0; cursor: pointer;">
                          <i class="fas fa-pen" style="font-size: 14px; color: #4A90E2;"></i>
                      </button>
                
                
              <form action="{% url 'delete_applied_service' service.id %}" method="post" style="display:inline-block; margin-left: 5px;">
                {% csrf_token %}
                <button type="button" class="icon-link delete-icon" title="Delete" data-bs-toggle="modal" data-bs-target="#deleteServiceModal{{ service.id }}">
                    <i class="fa fa-trash" aria-hidden="true"></i>
                </button>
            </form>
            
            
              </div>
            </div>
          </td>
          
          <td>{{ service.name }}</td>
          <td id="total-cost-{{ service.id }}" class="total-cost" data-service-id="{{ service.id }}">Loading...</td>
          <td>
            {% if service.status %}
                <span class="
                    {% if service.status == 'Assigned' %}text-primary{% endif %}
                    {% if service.status == 'Pending' %}text-danger{% endif %}
                    {% if service.status == 'Completed' %}text-success{% endif %}
                ">
                    {{service.status }}
                </span>
            {% else %}
                <span class="text-muted">No Status</span>
            {% endif %}
          </td>
          <td>{{ service.address }}</td>
          <td>
            <!-- Handle Contact Number -->
            <div>
              <i class="fa fa-phone" aria-hidden="true"></i> 
              {% if service.contact_number|slice:":1" == "+" %}
                {{ service.contact_number|slice:"3:" }}
              {% else %}
                {{ service.contact_number }}
              {% endif %}
            </div>
            <!-- Handle WhatsApp Number -->
            <div>
              {% if service.whatsapp_number %}
              <i class="fab fa-whatsapp" aria-hidden="true"></i> 
              {% if service.whatsapp_number|slice:":1" == "+" %}
                {{ service.whatsapp_number|slice:"3:" }}
              {% else %}
                {{ service.whatsapp_number }}
              {% endif %}
              {% endif %}
            </div>
          </td>
          <td>{{ service.referred_by }}</td>
          <td>{{ service.get_work_type_display }}</td>
          <td>{{ service.item_name_or_number }}</td>
          <td>{{ service.issue }}</td> <!-- Span across two columns -->
          <td>{{ service.estimated_price }}</td>
          <td>{{ service.estimated_date }}</td>
          <td>{{ service.service_by.username }}</td>
          <td>
            <ul class="files-list">
              {% if service.estimation_document %}
        <li><a href="{{ service.estimation_document.url }}" target="_blank">Document</a></li>
          {% endif %}
      {% if service.get_photos %}
         <li> <a href="{{ MEDIA_URL }}{{ service.get_photos.0 }}" data-lightbox="gallery-{{ service.id }}" data-title="Service Photos">Photo</a></li>

          {% for photo in service.get_photos|slice:"1:" %}
            <a href="{{ MEDIA_URL }}{{ photo }}" data-lightbox="gallery-{{ service.id }}" style="display: none;"></a>
          {% endfor %}
      {% endif %}
              
            </ul>
          </td>
          
        
          <td>{{ service.any_other_comments }}</td>
          
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div> 
</div>


<!-- Delete Confirmation Modal -->
{% for service in applied_services %}
<div class="modal fade custom-modal" id="deleteServiceModal{{ service.id }}" tabindex="-1" aria-labelledby="deleteServiceLabel" aria-hidden="true" data-bs-backdrop="false" style="background-color: rgba(0, 0, 0, 0.5);">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header custom-modal-header">
              <h5 class="modal-title">Confirm Delete</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <p>Are you sure you want to delete this applied service?</p>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              
              <!-- Delete Form (Confirmed on Click) -->
              <form action="{% url 'delete_applied_service' service.id %}" method="post">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-danger">Delete</button>
              </form>
          </div>
      </div>
  </div>
</div>
{% endfor %}



{% endblock %}

   
   
  


<!-- The Modal Add Customer-->
<div class="modal addmodal" id="customerModal" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Customer</h5>
        <button type="button" class="close" onclick="closeCustomerModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="customerForm">
          {% csrf_token %}
          <div class="form-group">
            <label for="name">Name:</label>
            <input type="text" class="form-control" id="name" name="name" required>
          </div>
          <div class="form-group">
            <label for="contact_number">Contact Number:</label>
            <input type="text" class="form-control" id="contact_number" name="contact_number" required>
          </div>
          <div class="form-group">
            <label for="whatsapp_number">WhatsApp Number:</label>
            <input type="text" class="form-control" id="whatsapp_number" name="whatsapp_number">
          </div>
          <div class="form-group">
            <label for="address">Address:</label>
            <input type="text" class="form-control" id="address" name="address">
          </div>
          <div class="form-group">
            <label for="referred_by">Referred By:</label>
            <input type="text" class="form-control" id="referred_by" name="referred_by">
          </div>
          <button type="submit" class="btn btn-primary">Save</button>     
        </form>
        
        <!-- Success/Error Messages -->
        <div id="customerMessage" class="mt-2"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    $(".total-cost").each(function() {
        var serviceId = $(this).data("service-id");
        var costElement = $(this);

        $.ajax({
            url: `/velvetekapp/calculate-total-cost/${serviceId}/`,
            type: "GET",
            dataType: "json",
            success: function(data) {
              console.log("Response for service", serviceId, ":", data);
                if (data.total_cost > 0) {
                    costElement.html(`<a href="/velvetekapp/extra_work_admin/${serviceId}/">${data.total_cost}</a>`);
                } else {
                    costElement.html("None");
                }
            },
            error: function() {
                costElement.html("Error fetching cost");
            }
        });
    });
});
</script>
<script>
  $(document).ready(function() {
    function loadCustomers() {
        $.ajax({
            url: "{% url 'new_customer' %}",
            type: "GET",
            success: function(response) {
                console.log("Customers list loaded:", response); // Debugging
                $("#customerList").empty();
                response.customers.forEach(function(customer) {
                    $("#customerList").append(
                        `<li class="list-group-item">${customer.name} - ${customer.email}</li>`
                    );
                });
            },
            error: function() {
                console.error("Error fetching customers.");
            }
        });
    }

    loadCustomers(); // Load customer list on page load

    $("#customerForm").submit(function(event) {
        event.preventDefault();

        $.ajax({
            type: "POST",
            url: "{% url 'add_customer' %}",
            data: $(this).serialize(),
            success: function(response) {
                console.log("Customer added response:", response); // Debugging
                
                $("#customerMessage").html(
                    '<div class="alert alert-success">' + response.message + '</div>'
                );

                setTimeout(function() {
                    $("#customerModal").modal("hide"); // Close modal properly
                }, 1000);

                $("#customerForm")[0].reset(); // Reset form after success
                
                setTimeout(() => {
                location.reload();
            }, 500);
            },
            error: function(xhr) {
                console.error("Error adding customer:", xhr.responseText); // Debugging
                var errorMessage = "Something went wrong.";
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                $("#customerMessage").html(
                    '<div class="alert alert-danger">' + errorMessage + '</div>'
                );
            }
        });
    });

    // Ensure modal properly hides with Bootstrap
    $("#customerModal").on("hidden.bs.modal", function () {
        $("#customerMessage").html(""); // Clear messages when closing
    });

  });
</script>



<!-- Technician Modal -->
<div class="modal addmodal" id="technicianModal" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Technician</h5>
        <button type="button" class="close" onclick="closeTechnicianModal()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="technicianForm">
          {% csrf_token %}
          <div class="form-group">
            <label for="username">Username</label>
            <input type="text" class="form-control" name="username" id="username" required>
          </div>
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" class="form-control" name="email" id="email" required>
          </div>

          <div class="form-group">
            <label for="contact_number">Contact Number</label>
            <input type="text" class="form-control" name="contact_number" id="contact_number" required>
          </div>
          
          <div class="form-group">
            <label for="whatsapp_number">WhatsApp Number</label>
            <input type="text" class="form-control" name="whatsapp_number" id="whatsapp_number" required>
          </div>

          <div class="form-group">
            <label for="password">Password</label>
            <div class="position-relative">
              <input type="password" class="form-control pr-4" name="password" id="password" required>
              <i id="eyeIcon" class="fa fa-eye position-absolute" 
                 style="right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;" 
                 onclick="togglePassword()"></i>
            </div>
          </div>

          
          <button type="submit" class="btn btn-primary">Save</button>     
        </form>
        
        <!-- Success/Error Messages -->
        <div id="technicianMessage" class="mt-2"></div>
      </div>
    </div>
  </div>
</div>


<script>
  function togglePassword() {
    let passwordField = document.getElementById("password");
    let eyeIcon = document.getElementById("eyeIcon");

    if (passwordField.type === "password") {
      passwordField.type = "text";
      eyeIcon.classList.remove("fa-eye");
      eyeIcon.classList.add("fa-eye-slash");
    } else {
      passwordField.type = "password";
      eyeIcon.classList.remove("fa-eye-slash");
      eyeIcon.classList.add("fa-eye");
    }
  }
</script>




<script>
  $(document).ready(function() {
    function loadTechnicians() {
        $.ajax({
            url: "{% url 'list_technicians' %}",
            type: "GET",
            success: function(response) {
                console.log("Technicians list loaded:", response); // Debugging
                $("#technicianList").empty();
                response.technicians.forEach(function(technician) {
                    $("#technicianList").append(
                        `<li class="list-group-item">${technician.username} - ${technician.email}</li>`
                    );
                });
            },
            error: function() {
                console.error("Error fetching technicians.");
            }
        });
    }

    loadTechnicians(); // Load on page load

    $("#technicianForm").submit(function(event) {
        event.preventDefault();

        $.ajax({
            type: "POST",
            url: "{% url 'add_technician' %}",
            data: $(this).serialize(),
            success: function(response) {
                console.log("Technician added response:", response); // Debugging
                
                $("#technicianMessage").html(
                    '<div class="alert alert-success">' + response.message + '</div>'
                );

                setTimeout(function() {
                    $("#technicianModal").hide();
                    $("body").removeClass("modal-open");
                    $(".modal-backdrop").remove();
                }, 4000);

                $("#technicianForm")[0].reset();
                
                setTimeout(() => {
                location.reload();
            }, 500);
            },
            error: function(xhr) {
                console.error("Error adding technician:", xhr.responseText); // Debugging
                var errorMessage = "Something went wrong.";
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                $("#technicianMessage").html(
                    '<div class="alert alert-danger">' + errorMessage + '</div>'
                );
            }
        });
    });
});
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<script>
  // Open the modal
  function openCustomerModal() {
      document.getElementById("customerModal").style.display = "block";
  }

  // Close the modal
  function closeCustomerModal() {
      document.getElementById("customerModal").style.display = "none";
  }

  // Close modal if clicking outside of the modal dialog
  window.onclick = function(event) {
      if (event.target == document.getElementById("customerModal")) {
          closeCustomerModal();
      }
  }
</script>


<script>
  // Technician Modal Functions
  function openTechnicianModal() {
    document.getElementById('technicianModal').style.display = "block";
  }

  function closeTechnicianModal() {
    document.getElementById('technicianModal').style.display = "none";
  }

  // Close modal if clicking outside of the modal dialog
  window.onclick = function(event) {
    if (event.target == document.getElementById("technicianModal")) {
      closeTechnicianModal();
    }
  };
</script>



<script>
    // Function to toggle the sidebar visibility
    function toggleSidebar() {
      const sidebar = document.querySelector('.sidebar');
      
      if (window.innerWidth <= 768) {  // Only apply for mobile view
        sidebar.classList.toggle('expanded');
    }else{sidebar.classList.toggle('show');}
    }

    
const notFoundDiv = document.getElementById('customer_not_found');
  const resultsDiv = document.getElementById('customer_results'); 

function searchCustomer() {
  const query = document.getElementById('contact_number').value;

  console.log('Search query:', query); // Debugging
  
  resultsDiv.innerHTML = ''; // Clear previous results
  notFoundDiv.style.display = 'none'; 

  fetch(`/technician/search_customer/?q=${query}`)
    .then(response => response.json())
    .then(data => {
      console.log('Search results:', data);
      if (data.exists) {
                // Autofill the fields if the customer exists
                data.results.forEach(customer => {
                    const div = document.createElement('div');
                    div.textContent = `${customer.name} - ${customer.contact_number}`;
                    div.onclick = () => selectCustomer(customer);
                    resultsDiv.appendChild(div);
                });
            } else {
                // Enable the fields for manual input if the customer doesn't exist
                enableManualInput();
                notFoundDiv.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error fetching customer data:', error);
            resultsDiv.innerHTML = '<div>Error loading results. Please try again later.</div>';
            notFoundDiv.style.display = 'none'; 
        });
}

function enableManualInput() {
    // Enable the fields for manual input
    document.getElementById('name').readOnly = false;
    document.getElementById('address').readOnly = false;
    document.getElementById('whatsapp_number').readOnly = false;
    document.getElementById('referred_by').readOnly = false;
}

function copyContactToWhatsApp() {
    const sameAsContact = document.getElementById('same_as_contact');
    const customerNumber = document.getElementById('contact_number'); // Use customer_number
    const whatsappNumber = document.getElementById('whatsapp_number');

    if (sameAsContact.checked) {
        whatsappNumber.value = customerNumber.value; // Copy customer number to WhatsApp number
    } else {
        whatsappNumber.value = ''; // Clear WhatsApp number if unchecked
    }
}

function selectCustomer(customer) {
    // Autofill the fields when a customer is selected
    document.getElementById('contact_number').value = customer.contact_number;
    document.getElementById('name').value = customer.name;
    document.getElementById('address').value = customer.address;
    document.getElementById('whatsapp_number').value = customer.whatsapp_number;
    document.getElementById('referred_by').value = customer.referred_by;

    // Make the fields read-only again
    document.getElementById('name').readOnly = true;
    document.getElementById('address').readOnly = true;
    document.getElementById('whatsapp_number').readOnly = true;
    document.getElementById('referred_by').readOnly = true;

    
    // Clear the search results and hide the "not found" message
  document.getElementById('customer_results').innerHTML = '';
  document.getElementById('customer_not_found').style.display = 'none';

}
      
    $(document).ready(function() {
        // Fetch technicians via AJAX
        $.ajax({
            url: '/technician/get_users/',  // URL to the API endpoint
            method: 'GET',
            success: function(data) {
                // Populate the dropdown
                const dropdown = $('#service_by');
                dropdown.empty();  // Clear existing options
                dropdown.append('<option value="">Select a technician</option>');  // Add default option
                data.forEach(function(technician) {
                    dropdown.append(`<option value="${technician.id}">${technician.username}</option>`);
                });
            },
            error: function(error) {
                console.error('Error fetching technicians:', error);
            }
        });
    });
    document.addEventListener("DOMContentLoaded", function () {
    let flashData = sessionStorage.getItem("flashMessage");
    if (flashData) {
        let { type, text } = JSON.parse(flashData);
        showFlashMessage(type, text);
        sessionStorage.removeItem("flashMessage"); // ‚úÖ Remove after displaying
    }
});

function showFlashMessage(type, message) {
    let flashContainer = document.getElementById("flashMessages");
    if (!flashContainer) {
        flashContainer = document.createElement("div");
        flashContainer.id = "flash-messages";
        flashContainer.style.position = "fixed";
        flashContainer.style.top = "0";
        flashContainer.style.left = "15%";
        flashContainer.style.width = "100%";
        flashContainer.style.zIndex = "1000";
        flashContainer.style.textAlign = "left"; // ‚úÖ Center text
        flashContainer.style.padding = "15px";
        flashContainer.style.fontSize = "16px";
        document.body.prepend(flashContainer);
    }

    let flashMessage = document.createElement("div");
    flashMessage.className = `alert alert-${type}`;
    flashMessage.style.display = "inline-block";
    flashMessage.style.padding = "15px 20px";
    flashMessage.style.width = "100%";  // ‚úÖ Full-width
    flashMessage.style.margin = "0";  // ‚úÖ No extra spacing
    flashMessage.style.borderRadius = "0";  // ‚úÖ Remove rounded edges
    flashMessage.style.boxShadow = "0 2px 10px rgba(0,0,0,0.2)";
    flashMessage.style.borderRadius = "12px"; 
    flashMessage.style.fontWeight = "bold";
    flashMessage.innerHTML = message;

    flashContainer.appendChild(flashMessage);

    setTimeout(() => {
        flashMessage.remove();
    }, 3000);
}
document.getElementById('addServiceForm').addEventListener('submit', function(event) {
    event.preventDefault();

    const form = document.getElementById('addServiceForm');
    const formData = new FormData(this);
    const serviceId = form.getAttribute("data-service-id");
    
    let messageContainer = document.getElementById("serviceMessage");
    let url = serviceId ? `/technician/update_service/${serviceId}/` : `/technician/add_service/`;

    if (window.removedFiles && window.removedFiles.length > 0) {
        formData.append("removed_files", JSON.stringify(window.removedFiles));
    }

    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector("[name=csrfmiddlewaretoken]").value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let message = serviceId ? "Service updated successfully!" :
                         (data.is_new_customer ? "Customer added successfully! Service request submitted and WhatsApp message sent successfully!" : "Service request submitted and WhatsApp message sent successfully!");

            messageContainer.innerHTML = `<div class="alert alert-success">${message}</div>`;

            // ‚úÖ Close Modal Before Reloading Page
            let modalElement = document.getElementById("addServiceModal");
            let modalInstance = bootstrap.Modal.getOrCreateInstance(modalElement); // Ensures modal instance exists

            setTimeout(function () {
                if (modalInstance) {
                    modalInstance.hide(); // Close modal
                }
                messageContainer.innerHTML = ""; 

                // ‚úÖ Reload After Modal is Fully Closed
                setTimeout(function () {
                    location.reload();
                }, 500); // Small delay to ensure the modal closes before reload

            }, 2000);

        } else {
            let message = `Error: ${data.message || JSON.stringify(data.errors)}`;

            if (data.warning_message) {
                message += `<br><span class="text-warning">${data.warning_message}</span>`;
            }

            messageContainer.innerHTML = `<div class="alert alert-danger">${message}</div>`;
        }
    })
    .catch(error => {
        console.error("Error:", error);
        messageContainer.innerHTML = `<div class="alert alert-danger">An error occurred. Please try again later.</div>`;
    });
});


    // Modal handling
    const modal = document.getElementById('addServiceModal');

    // Open the modal
function openModal() {
  document.getElementById('addServiceForm').reset();
  document.getElementById('customer_results').innerHTML = '';
  document.getElementById('name').readOnly = false;
  document.getElementById('address').readOnly = false;
  document.getElementById('whatsapp_number').readOnly = false;
  document.getElementById('referred_by').readOnly = false;
  document.getElementById('addServiceModal').style.display = 'flex';
}

// Close the modal
function closeModal() {
  notFoundDiv.style.display = 'none'; 
  
  document.getElementById('customer_results').innerHTML = '';
  document.getElementById('addServiceModal').style.display = 'none';
}

// Prevent closing when clicking outside the modal
document.getElementById('addServiceModal').addEventListener('click', function (event) {
  if (event.target === this) {
    event.stopPropagation(); // Prevent closing
  }
});

    window.onclick = function(event) {
      if (event.target == modal) {
        closeModal();
      }
    }
    let filter='date'
    function updatePlaceholder(filter) {
    const searchBar = document.getElementById("searchBar");
    const rangeFields = document.getElementById("rangeFields");
    const startValue = document.getElementById("startValue");
    const endValue = document.getElementById("endValue");

    // Hide the Search Bar and Show Range Fields if a Range Filter is Selected
    if (filter === "dateRange" || filter === "monthRange" || filter === "yearRange") {
        searchBar.classList.add("d-none"); // Hide Search Bar
        rangeFields.classList.remove("d-none"); // Show Range Fields
    } else {
        searchBar.classList.remove("d-none"); // Show Search Bar
        rangeFields.classList.add("d-none"); // Hide Range Fields
    }

    // Change the Search Bar Type and Placeholder Based on Filter Selection
    if (filter === "date") {
        searchBar.type = "date";
        searchBar.placeholder = "Search by Date";
    } else if (filter === "month") {
        searchBar.type = "month";
        searchBar.setAttribute("data-placeholder", "Search by Month");
        searchBar.value = ""; // Clear the value
        searchBar.classList.add("month-placeholder"); // Add a custom class
    } else if (filter === "year") {
        searchBar.type = "number";
        searchBar.placeholder = "Search by Year";
    } else {
        // Update Range Fields for Date, Month, or Year Ranges
        if (filter === "dateRange") {
            startValue.type = "date";
            endValue.type = "date";
            startValue.placeholder = "Start Date";
            endValue.placeholder = "End Date";
        } else if (filter === "monthRange") {
          startValue.type = "month";
            endValue.type = "month";
            // Workaround for month range placeholders
            startValue.setAttribute("data-placeholder", "Start Month");
            endValue.setAttribute("data-placeholder", "End Month");
            startValue.value = ""; // Clear the value
            endValue.value = ""; // Clear the value
            startValue.classList.add("month-placeholder"); // Add a custom class
            endValue.classList.add("month-placeholder"); // Add a custom class
        } else if (filter === "yearRange") {
            startValue.type = "number";
            endValue.type = "number";
            startValue.placeholder = "Start Year";
            endValue.placeholder = "End Year";
        }
    }
}

document.addEventListener("input", function (e) {
    if (e.target.type === "month" && e.target.classList.contains("month-placeholder")) {
        if (e.target.value) {
            e.target.classList.remove("month-placeholder");
        } else {
            e.target.classList.add("month-placeholder");
        }
    }
});

// Handle filter selection from the dropdown
document.querySelectorAll('.dropdown-item').forEach(item => {
    item.addEventListener('click', function (e) {
        e.preventDefault();
        filter = this.getAttribute('data-filter');
        updatePlaceholder(filter);
    });
});

// Handle search button click
document.getElementById("searchBtn").addEventListener("click", function () {
    const searchBar = document.getElementById("searchBar");
    const startValue = document.getElementById("startValue");
    const endValue = document.getElementById("endValue");

    let query = "";
    

    // Check if values exist before constructing the query
    if ((filter === "dateRange" || filter === "monthRange" || filter === "yearRange") && startValue.value && endValue.value) {
        query = `start=${startValue.value}&end=${endValue.value}`;
    } else if (searchBar.value.trim() !== "") {
        query = `query=${searchBar.value.trim()}`;
    } else {
        // If no valid values exist, return early and prevent navigation
        showFlashMessage("warning", "Please enter a search value before proceeding.");
        return;
    }

    // Construct the URL with the filter type and query
    const baseUrl = "{% url 'filter_applied_services' %}";
    const url = `${baseUrl}?filterType=${filter}&${query}`;
    // Redirect to the constructed URL
    window.location.href = url;
});


// Reset the filter to show all tasks
document.getElementById("resetBtn").addEventListener("click", function () {
    document.getElementById("searchBar").value = ""; // Clear search bar
    document.getElementById("searchBar").classList.remove("d-none"); // Show search bar
    document.getElementById("rangeFields").classList.add("d-none"); // Hide range fields
    updatePlaceholder("date"); // Reset to default filter
    window.location.href = "{% url 'reset_filter_applied_services' %}"; // Redirect to reset and show all services
});

// Initial call to update placeholders based on the default filter option
updatePlaceholder("date");
</script>
  <!-- Lightbox JS -->
<script src="https://cdn.jsdelivr.net/npm/lightbox2@2.11.3/dist/js/lightbox.min.js"></script>
<script>
  let selectedFiles = new DataTransfer();
  let existingPhotos = []; // Array to store existing photo URLs

  document.querySelectorAll(".edit-service-btn").forEach(button => {
    button.addEventListener("click", function () {
        let serviceId = this.getAttribute("data-service-id");
        let serviceByDropdown = document.getElementById("service_by");

        fetch(`/technician/get_service/${serviceId}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById("contact_number").value = data.contact_number;
                document.getElementById("name").value = data.name;
                document.getElementById("address").value = data.address;
                document.getElementById("whatsapp_number").value = data.whatsapp_number;
                document.getElementById("referred_by").value = data.referred_by;
                let selectedOption = [...serviceByDropdown.options].find(option => option.textContent.trim() === data.service_by);

                if (selectedOption) {
                    selectedOption.selected = true;  // Set the matching option
                } else {
                    console.warn("Technician name not found:", data.service_by_name);
                }
                console.log(selectedOption)
                document.getElementById("work_type").value = data.work_type;
                document.getElementById("item_name_or_number").value = data.item_name_or_number;
                document.getElementById("issue").value = data.issue;
                document.getElementById("estimated_price").value = data.estimated_price;
                document.getElementById("estimated_date").value = data.estimated_date;
                document.getElementById("any_other_comments").value = data.any_other_comments;

                document.getElementById("addServiceForm").setAttribute("data-service-id", serviceId);
               
                selectedFiles = new DataTransfer();
                existingPhotos = [...data.photos_of_item]; // Store existing photos
                fileNamesDisplay.innerHTML = "";

                // Display Existing Photos
                existingPhotos.forEach((photoUrl, index) => {
                    const fileItem = document.createElement("div");
                    fileItem.className = "file-item";
                    fileItem.innerHTML = `
                        <span class="file-name">${photoUrl.split('/').pop()}</span>
                        <span class="delete-btn" onclick="removeExistingFile(${index}, '${photoUrl}', event)">√ó</span>
                    `;
                    fileNamesDisplay.appendChild(fileItem);
                });
                // Handle Estimation Document
                let estimationDocDisplay = document.getElementById("estimation_document_display"); // ‚úÖ Target correct element

                if (!estimationDocDisplay) {
                    console.error("‚ùå Element #estimation_document_display not found!");
                } else {
                    estimationDocDisplay.innerHTML = "";  // Clear previous data
                    console.log("‚úÖ Estimation Document Display Element Found.");

                    if (data.estimation_document) {
                        console.log("üìÇ Estimation Document URL:", data.estimation_document);

                        // Extract filename from path
                        let fileName = data.estimation_document.split('/').pop();
                        console.log("üìÑ Extracted File Name:", fileName);

                        // Display file name with a link to the document
                        estimationDocDisplay.innerHTML = `
                            <a href="${data.estimation_document}" target="_blank" class="doc-name">${fileName}</a>
                        `;
                        console.log("‚úÖ Document link added successfully.");
                    } else {
                        console.warn("‚ö†Ô∏è No estimation document found.");
                        estimationDocDisplay.innerHTML = `<span class="doc-name">No document uploaded</span>`;
                    }
                }


                
                
                document.getElementById('addServiceModal').style.display = 'flex';
            })
            .catch(error => console.error("Error fetching data:", error));
    });
});

  const fileInput = document.getElementById('photos_of_item');
  const fileNamesDisplay = document.getElementById('fileNamesDisplay');

  fileInput.addEventListener('change', function(e) {
      // Add new files to existing selection
      Array.from(this.files).forEach(file => {
          selectedFiles.items.add(file);
      });
      
      // Update the input's files
      fileInput.files = selectedFiles.files;
      
      // Update display
      updateFileNames();
  });

  function removeFile(index, event) {
      event.stopPropagation();
      const newFiles = new DataTransfer();
      Array.from(selectedFiles.files)
          .filter((file, i) => i !== index)
          .forEach(file => newFiles.items.add(file));
      
      selectedFiles = newFiles;
      fileInput.files = selectedFiles.files;
      updateFileNames();
  }

  function updateFileNames() {
    fileNamesDisplay.innerHTML = '';
    
    // Display existing photos first
    existingPhotos.forEach((photoUrl, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
            <span class="file-name">${photoUrl.split('/').pop()}</span>
            <span class="delete-btn" onclick="removeExistingFile(${index}, '${photoUrl}', event)">√ó</span>
        `;
        fileNamesDisplay.appendChild(fileItem);
    });
    // Then display newly added files
    Array.from(selectedFiles.files).forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
            <span class="file-name">${file.name}</span>
            <span class="delete-btn" onclick="removeFile(${index}, event)">√ó</span>
        `;
        fileNamesDisplay.appendChild(fileItem);
    });
      if (existingPhotos.length === 0 && selectedFiles.files.length === 0) {
        fileNamesDisplay.textContent = 'No files selected';
    }
  }
  function removeExistingFile(index, fileUrl, event) {
    event.stopPropagation();

     
    // Remove from existingPhotos array
    existingPhotos = existingPhotos.filter((url, i) => i !== index);
    
    // Remove from display
    event.target.parentElement.remove();
    
    // Store removed file to handle in backend
    if (!window.removedFiles) window.removedFiles = [];
    window.removedFiles.push(fileUrl);
}

</script>
<script>
  function exportData() {
    let status = "{{ current_filter|default:'all' }}"; // Ensure status is always set
    let baseUrl = "{% url 'export_applied_services' status='__status__' %}".replace('__status__', status);

    let params = new URLSearchParams({
        filterType: "{{ request.GET.filterType|default:'' }}",
        query: "{{ request.GET.query|default:'' }}",
        start: "{{ request.GET.start|default:'' }}",
        end: "{{ request.GET.end|default:'' }}"
    });

    fetch(baseUrl + "?" + params.toString(), { method: "GET" })
    .then(response => {
        if (response.status === 204) {
            showFlashMessage("warning", " No data found for the selected filters.");
        } else if (response.ok) {
          showFlashMessage("success", "Export completed successfully!");
          window.location.href = baseUrl + "?" + params.toString();
        } else {
            showFlashMessage("danger", " An error occurred while exporting.");
        }
    })
    .catch(error => {
        console.error("Export Error:", error);
        showFlashMessage("danger", "An unexpected error occurred.");
    });

}
</script>

</body>
</html>